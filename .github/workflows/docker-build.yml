name: Docker Build and Deploy
 
on:
  push:
    branches:
      - main  # Change this to the branch you want to trigger the build on
 
jobs:
  build-and-deploy:
  
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [10.x, 12.x, 14.x, 16.x, 18.x]
        
    steps:
    
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Build and tag Docker image
      run: |
        docker build -t docfx-build .
        docker tag docfx-build docker.io/docfx-build
 
    - name: Log in to Docker registry
      run: docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }} docker.io
 
    - name: Push Docker image to registry
      run: docker push docker.io/docfx-build
 
    - name: Remove existing containers and images
      run: |
        docker stop $(docker ps -a -q)
        docker rm $(docker ps -a -q)
        docker rmi $(docker images -q)
 
    - name: Create and start new container
      run: docker run -d -p 8080:80 --name docfx-container docker.io/docfx-build
 
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@4.1.1
      with:
        branch: gh-pages
        folder: .  # Change this if your static files are located in a different directory
